worker_processes  auto;
worker_cpu_affinity auto;
worker_rlimit_nofile 300000;

events {
    worker_connections  16000;
    use epoll;
	accept_mutex on;
	multi_accept on;
}

http {
    include mime.types;
    default_type application/octet-stream;
	
    access_log off;

	server_tokens off;
    access_log off;
	aio threads;
    sendfile on;
	sendfile_max_chunk 512k;
    tcp_nopush on;
	tcp_nodelay on;
    keepalive_timeout 65;

	gzip off;

    server {
		listen 84;
        listen 8443 ssl http2;
        server_name  localhost;
		access_log off;
		
        ssl_certificate /usr/local/openresty/nginx/conf/gcorelabs_xyz.crt;
        ssl_certificate_key /usr/local/openresty/nginx/conf/gcorelabs_xyz.key;
		ssl_protocols SSLv3 TLSv1.1 TLSv1.2;

        ssl_session_cache shared:SSL:1m;
        ssl_session_timeout 5m;

        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
	
        location / {
            root html;
			index  index.php;
        }
		
		location /hls {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
				text/html html;
            }
            root /tmp;
            add_header Cache-Control no-cache;
			add_header 'Access-Control-Allow-Origin' '*' always;
			
			if ($request_method = 'OPTIONS') {
					add_header 'Access-Control-Allow-Origin' '*';
					add_header 'Access-Control-Max-Age' 1728000;
					add_header 'Content-Type' 'text/plain charset=UTF-8';
					add_header 'Content-Length' 0;
					return 204;
			}
			
			valid_referers server_names;
            if ($invalid_referer) {
                return 403;
            }
			secure_link $arg_md5,$arg_expires;
            secure_link_md5 "$secure_link_expires$uri$remote_addr SECRET_KEY";

			location ~ \.m3u8 {
				if ($secure_link = "") { return 403; }
				if ($secure_link = "0") { return 410; }
			}
		}
		location /dash {
            types {
				application/dash+xml mpd;
				video/mp4 mp4;
				text/html html;
            }
            root /tmp;
            add_header Cache-Control no-cache;
			add_header 'Access-Control-Allow-Origin' '*' always;
			
			if ($request_method = 'OPTIONS') {
					add_header 'Access-Control-Allow-Origin' '*';
					add_header 'Access-Control-Max-Age' 1728000;
					add_header 'Content-Type' 'text/plain charset=UTF-8';
					add_header 'Content-Length' 0;
					return 204;
			}
			
			valid_referers server_names;
            if ($invalid_referer) {
                return 403;
            }
			secure_link $arg_md5,$arg_expires;
            secure_link_md5 "$secure_link_expires$uri$remote_addr SECRET_KEY";

			location ~ \.mpd {
				if ($secure_link = "") { return 403; }
				if ($secure_link = "0") { return 410; }
			}
		}
		location /ww2status {
        stub_status;
		  add_header 'Content-Type' 'application/json';
			return 200 '{\r"connections_active": $connections_active,\r"connections_reading": $connections_reading,\r"connections_writing": $connections_writing,\r"connections_waiting": $connections_waiting\r}';
		}
		#location /stat {
        #    rtmp_stat all;
        #    rtmp_stat_stylesheet stat.xsl;
        #}
		
        #location /stat.xsl {
        #    root /usr/local/openresty/nginx/html;
		#}
		
		location ~* \.php$ {
			fastcgi_index   index.php;
			fastcgi_pass    127.0.0.1:9000;
			include         fastcgi_params;
			fastcgi_param   SCRIPT_FILENAME    $document_root$fastcgi_script_name;
			fastcgi_param   SCRIPT_NAME        $fastcgi_script_name;
		}

    }
server {
		listen 88;
        listen 2096 ssl http2;
        server_name  localhost;
		access_log off;
		
        ssl_certificate /usr/local/openresty/nginx/conf/strlabs_top.crt;
        ssl_certificate_key /usr/local/openresty/nginx/conf/strlabs_top.key;
		ssl_protocols SSLv3 TLSv1.1 TLSv1.2;

        ssl_session_cache shared:SSL:1m;
        ssl_session_timeout 5m;

        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
	
        location / {
            root html;
			index  index.php;
        }
		
		location /hls {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
				text/html html;
            }
            root /tmp;
            add_header Cache-Control no-cache;
			add_header 'Access-Control-Allow-Origin' '*' always;
			
			if ($request_method = 'OPTIONS') {
					add_header 'Access-Control-Allow-Origin' '*';
					add_header 'Access-Control-Max-Age' 1728000;
					add_header 'Content-Type' 'text/plain charset=UTF-8';
					add_header 'Content-Length' 0;
					return 204;
			}
			
			valid_referers server_names;
            if ($invalid_referer) {
                return 403;
            }
			secure_link $arg_md5,$arg_expires;
            secure_link_md5 "$secure_link_expires$uri$remote_addr SECRET_KEY";

			location ~ \.m3u8 {
				if ($secure_link = "") { return 403; }
				if ($secure_link = "0") { return 410; }
			}
		}
		location /dash {
            types {
				application/dash+xml mpd;
				video/mp4 mp4;
				text/html html;
            }
            root /tmp;
            add_header Cache-Control no-cache;
			add_header 'Access-Control-Allow-Origin' '*' always;
			
			if ($request_method = 'OPTIONS') {
					add_header 'Access-Control-Allow-Origin' '*';
					add_header 'Access-Control-Max-Age' 1728000;
					add_header 'Content-Type' 'text/plain charset=UTF-8';
					add_header 'Content-Length' 0;
					return 204;
			}
			
			valid_referers server_names;
            if ($invalid_referer) {
                return 403;
            }
			secure_link $arg_md5,$arg_expires;
            secure_link_md5 "$secure_link_expires$uri$remote_addr SECRET_KEY";

			location ~ \.mpd {
				if ($secure_link = "") { return 403; }
				if ($secure_link = "0") { return 410; }
			}
		}
		location /ww2status {
        stub_status;
		  add_header 'Content-Type' 'application/json';
			return 200 '{\r"connections_active": $connections_active,\r"connections_reading": $connections_reading,\r"connections_writing": $connections_writing,\r"connections_waiting": $connections_waiting\r}';
		}
		#location /stat {
        #    rtmp_stat all;
        #    rtmp_stat_stylesheet stat.xsl;
        #}
		
        #location /stat.xsl {
        #    root /usr/local/openresty/nginx/html;
		#}
		
		location ~* \.php$ {
			fastcgi_index   index.php;
			fastcgi_pass    127.0.0.1:9000;
			include         fastcgi_params;
			fastcgi_param   SCRIPT_FILENAME    $document_root$fastcgi_script_name;
			fastcgi_param   SCRIPT_NAME        $fastcgi_script_name;
		}

    }
}
rtmp { 
    server {
		listen 1999; 
		chunk_size 4096;
		
  application x {
          live on;
		  interleave on;
		  
          hls on; 
          hls_path /tmp/hls;
		  hls_nested on;
		  #hls_fragment 15s;
          #hls_playlist_length 15;
	 
		  dash on;
		  dash_path /tmp/dash;
		  dash_nested on;
		  #dash_fragment 15s;
          #dash_playlist_length 15;
		  
		  deny play all;

     } 

  } 
} 